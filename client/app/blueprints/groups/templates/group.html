{% extends "layout.html" %}
{% import "cell_fmt.html" as cell_format %}

{% block content %}
<div class="card bg-white mt-4 w-75 position-absolute translate-middle-x start-50">
    <div class="card-body">
        <div class="d-flex">
            <h1 class="me-auto">Group {{group_id}}</h1>
        </div>
        <hr>
        <form id="sampleForm" class="execute-form" method="POST" action="{{ url_for('cluster.cgmlst') }}">
            <button id="cluster-button" class="btn btn-success" disabled="disabled">
                <span id="cluster-btn-spinner" hidden class="spinner-grow spinner-grow-sm"></span>
                <span id="cluster-btn-text">Cluster samples</span>
            </button>
            <table id="data-table" class="table table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-samples"  name="selectAll"></th>
                        {% for column in table_definition %}
                        <th>{{ column.label }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody id="data-table-body" class="table-hover">
                    {% for sample in samples %}
                    <tr>
                        <td><input type="checkbox" class="sample-checkbox" name="samples" value="{{sample.sampleId}}"></td>
                        {% for column in table_definition %}
                            {% set macro_name = 'render_' + column.type %}
                            <th>
                                {{ cell_format[macro_name](sample | json_path(column.path)) }}
                            </th>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
</div>
<script>
    const checkItAll = document.getElementById('select-all-samples');
    const sampleCheckboxes = document.querySelectorAll('[class=sample-checkbox]');
    checkItAll.addEventListener('change', () => {
        if (checkItAll.checked) {
            sampleCheckboxes.forEach(input => {
                input.checked = true;
                });
        } else {
            sampleCheckboxes.forEach(input => {
                input.checked = false;
                });
            }
        });

    // enable cluster box when at least one samples has been selected
    document.getElementById("data-table-body").addEventListener("change", (event) => {
        const btn = document.getElementById("cluster-button")
        if (Array.from(sampleCheckboxes).some((checkbox) => checkbox.checked)) {
            btn.disabled = false
        } else {
            btn.disabled = true
        }
    });

    // add submit clustering function
    document
    .getElementById("cluster-button")
    .addEventListener("click", (event) => {
        event.preventDefault()  // prevent normal behaviour
        // show spinner
        event.target.innerText = "Clustering..."
        event.target.parentElement.querySelector("#cluster-btn-spinner").hidden = false
        // get sample ids for checked samples
        // submit clustering job
        // profit?
    })
</script>
{% endblock content %}

